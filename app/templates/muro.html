{% extends "base.html" %}

{% block surface_class %}surface-home{% endblock %}

{% block masthead %}
<section class="page-hero wall-hero">
  <div class="hero__legend">
    <h1 class="wall-hero__title">Muro de la Iglesia</h1>
    <p class="wall-hero__lead">
      Este espacio es para la comunidad: comparte <strong>preguntas biblicas</strong>,
      <strong>peticiones de oracion</strong>, palabras de animo o necesidades practicas.
      Todos pueden leer; para publicar o responder, inicia sesion. Mantengamos un tono
      respetuoso, evitando datos sensibles y cuidando la dignidad de cada persona.
    </p>
  </div>
</section>
{% endblock %}

{% block content %}
<div class="wall-composer">
  {% if errors %}
  <ul class="form-messages form-messages--error" role="alert">
    {% for message in errors %}<li>{{ message }}</li>{% endfor %}
  </ul>
  {% endif %}

  {% if current_user %}
  <form method="post" action="/muro/create" class="wall-composer__form">
    <div class="wall-composer__controls">
      <select class="form-input wall-composer__select" name="kind" aria-label="Tipo de publicacion">
        <option value="" selected>Selecciona tipo</option>
        <option value="pregunta">Pregunta</option>
        <option value="oracion">Peticion de oracion</option>
        <option value="anuncio">Anuncio</option>
        <option value="testimonio">Testimonio</option>
      </select>
    </div>
    <div class="wall-composer__field">
      <label class="sr-only" for="post-content">Escribe tu mensaje</label>
      <textarea
        class="form-input wall-composer__textarea"
        id="post-content"
        name="content"
        rows="3"
        maxlength="4000"
        placeholder="Escribe tu mensaje con respeto y claridad..."
        required
      >{{ (draft.content if draft else '') | default('') }}</textarea>
    </div>
    <div class="wall-composer__actions">
      <button class="button button--primary" type="submit">Publicar</button>
    </div>
  </form>
  {% else %}
  <div class="wall-cta">
    <div class="wall-cta__copy">
      <h3>Participa del muro</h3>
      <p>Inicia sesion para publicar una pregunta o peticion y responder a otros hermanos.</p>
    </div>
    <div class="wall-cta__actions">
      <a class="button button--outline" href="/login?next=/muro">Iniciar sesion</a>
      <a class="button button--primary" href="/register">Crear cuenta</a>
    </div>
  </div>
  {% endif %}
</div>

<h2 class="section-title">Publicaciones recientes</h2>

<ul class="wall-feed" data-wall>
  {% for post in posts %}
  <li class="wall-post" data-post>
    <header class="wall-post__head">
      <div class="wall-post__id">
        <span class="avatar-ring avatar-ring--sm"><span>{{ post.user.full_name[:1]|upper }}</span></span>
        <div class="wall-post__meta">
          <strong class="wall-post__author">{{ post.user.full_name }}</strong>
          <span class="wall-post__time">{{ post.created_at.strftime('%d %b %Y, %H:%M') }}</span>
        </div>
      </div>
      {% if current_user and (current_user.id == post.user_id or current_user.is_superuser) %}
      <form method="post" action="/muro/post/{{ post.id }}/delete" class="site-inline-form" data-action="delete-post" data-name="publicacion">
        <button type="submit" class="link-danger">Eliminar</button>
      </form>
      {% endif %}
    </header>
    <div class="wall-post__content">{{ post.content }}</div>

    {% set replies = post.replies or [] %}
    {% if replies|length > 0 %}
    <div class="wall-post__replies" data-replies-block>
      <div class="wall-reply wall-reply--first">
        <strong>{{ replies[0].user.full_name }}</strong>
        <span class="wall-post__time">&middot; {{ replies[0].created_at.strftime('%d %b %Y, %H:%M') }}</span>
        <p>{{ replies[0].content }}</p>
      </div>
      {% if replies|length > 1 %}
      <div class="wall-reply-list" data-replies hidden>
        {% for reply in replies[1:] %}
        <div class="wall-reply">
          <strong>{{ reply.user.full_name }}</strong>
          <span class="wall-post__time">&middot; {{ reply.created_at.strftime('%d %b %Y, %H:%M') }}</span>
          <p>{{ reply.content }}</p>
        </div>
        {% endfor %}
      </div>
      <div class="wall-post__more">
        <button class="button button--soft wall-replies-toggle" type="button" data-toggle-replies data-expanded="false">
          Ver todas las respuestas ({{ replies|length }})
        </button>
      </div>
      {% endif %}
    </div>
    {% endif %}

    {% if current_user %}
    <form method="post" action="/muro/post/{{ post.id }}/reply" class="wall-reply-form">
      <label class="sr-only" for="reply-{{ post.id }}">Agregar respuesta</label>
      <textarea class="form-input" id="reply-{{ post.id }}" name="content" rows="2" maxlength="4000" placeholder="Escribe una respuesta..." required></textarea>
      <div class="wall-reply-form__actions">
        <button class="button button--outline" type="submit">Responder</button>
      </div>
    </form>
    {% endif %}
  </li>
  {% else %}
  <li class="wall-post">
    <div class="wall-post__content">Aun no hay publicaciones. Se el primero en escribir y animar a la iglesia.</div>
  </li>
  {% endfor %}
</ul>

{% endblock %}
