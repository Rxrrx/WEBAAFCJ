{% extends "base.html" %}

{% block title %}Biblioteca | Biblioteca Apostólica{% endblock %}
{% block body_class %}page-library{% endblock %}

{% macro document_card(doc, current_user, variant="default") -%}
<article
  class="document-card{% if variant == 'compact' %} document-card--compact{% elif variant == 'row' %} document-card--row{% endif %}"
  data-doc-card
  data-doc-id="{{ doc.id }}"
  data-uploaded-at="{{ doc.uploaded_at.isoformat() if doc.uploaded_at else '' }}"
>
  <div class="document-card__type" aria-hidden="true">
    {{ "PDF" if doc.content_type == "application/pdf" else (doc.content_type.split('/')[-1].upper() if '/' in doc.content_type else doc.content_type) }}
  </div>
  <div class="document-card__body">
    <h3 class="document-card__title">{{ doc.filename }}</h3>
    <p class="document-card__meta">
      Publicado el {{ doc.uploaded_at.strftime("%d/%m/%Y %H:%M") }}
    </p>
    <div class="document-card__tags">
      {% if doc.category %}
      <span class="badge">{{ doc.category.name }}</span>
      {% endif %}
      {% if doc.subcategory %}
      <span class="badge badge--soft">{{ doc.subcategory.name }}</span>
      {% endif %}
    </div>
  </div>
  <div class="document-card__actions">
    <a
      class="button button--ghost"
      href="/documents/{{ doc.id }}/download"
      data-download-url="/documents/{{ doc.id }}/download"
      data-filename="{{ doc.filename }}"
    >
      Descargar
    </a>
    {% if doc.content_type == "application/pdf" %}
    <a
      class="button button--outline"
      href="/documents/{{ doc.id }}/view"
      data-view-url="/documents/{{ doc.id }}/view"
      data-filename="{{ doc.filename }}"
    >
      Abrir
    </a>
    {% endif %}
    {% if current_user and current_user.is_superuser %}
    <form
      class="action-inline-form"
      action="/documents/{{ doc.id }}/delete"
      method="post"
      data-action="delete-doc"
      data-filename="{{ doc.filename }}"
    >
      <button class="link-danger" type="submit">Eliminar</button>
    </form>
    {% endif %}
  </div>
</article>
{%- endmacro %}

{% block masthead %}
<section class="page-hero page-hero--library">
  <div class="page-hero__content">
    <h1>Biblioteca para aprender juntos</h1>
    <p>
      Explora rutas de estudio, materiales devocionales y planificaciones para cada ministerio.
      Usa el panel lateral para elegir la categoría que necesitas.
    </p>
  </div>
</section>
{% endblock %}

{% block surface_class %}surface-library{% endblock %}

{% block content %}
{% if category_groups %}
<div class="library-shell" data-library-shell>
  <aside class="library-sidebar">
    <header class="library-sidebar__header">
      <h2>Categorías</h2>
      <p>Selecciona una categoría para revisar sus recursos.</p>
    </header>
    <nav class="library-sidebar__nav" data-library-tabs role="tablist">
      {% for group in category_groups %}
      <button
        class="library-tab{{ ' is-active' if loop.first }}"
        type="button"
        data-target="category-{{ group.category.id }}"
        role="tab"
        id="tab-category-{{ group.category.id }}"
        aria-controls="category-{{ group.category.id }}"
        aria-selected="{{ 'true' if loop.first else 'false' }}"
      >
        <span class="library-tab__name">{{ group.category.name }}</span>
        <span class="library-tab__count">
          {{ group.total_documents }} recurso{{ 's' if group.total_documents != 1 }}
        </span>
      </button>
      {% endfor %}
      {% if uncategorized_documents %}
      <button
        class="library-tab"
        type="button"
        data-target="category-uncategorized"
        role="tab"
        id="tab-category-uncategorized"
        aria-controls="category-uncategorized"
        aria-selected="false"
      >
        <span class="library-tab__name">Sin categoría</span>
        <span class="library-tab__count">
          {{ uncategorized_documents|length }} recurso{{ 's' if uncategorized_documents|length != 1 }}
        </span>
      </button>
      {% endif %}
    </nav>
  </aside>

  <section class="library-stage" data-library-stage data-view="list" data-sort="admin">
    <div class="library-stage__toolbar">
      <div class="library-toolbar-group">
        <span class="library-stage__toolbar-label">Vista</span>
        <div class="library-view-toggle" data-library-view-toggle role="group" aria-label="Cambiar vista de documentos">
          <button
            class="view-toggle-button is-active"
            type="button"
            data-view="list"
            aria-pressed="true"
          >
            Lista
          </button>
          <button
            class="view-toggle-button"
            type="button"
            data-view="grid"
            aria-pressed="false"
          >
            Tarjetas
          </button>
        </div>
      </div>
      <div class="library-toolbar-group library-toolbar-group--sort">
        <label class="library-stage__toolbar-label" for="library-sort-control">Organizar</label>
        <select
          class="library-sort-select"
          id="library-sort-control"
          data-library-sort
        >
          <option value="admin">Predeterminado</option>
          <option value="newest">Más nuevos primero</option>
          <option value="oldest">Más antiguos primero</option>
        </select>
      </div>
    </div>
    {% for group in category_groups %}
    <article
      class="library-panel{{ ' is-active' if loop.first }}"
      id="category-{{ group.category.id }}"
      role="tabpanel"
      aria-labelledby="tab-category-{{ group.category.id }}"
      data-library-panel
    >
      <header class="library-panel__header">
        <div>
          <span class="library-panel__eyebrow">Categoría</span>
          <h2>{{ group.category.name }}</h2>
          <p>
            {{ group.total_documents }} recurso{{ 's' if group.total_documents != 1 }}
            {% if group.subcategories %}
            · {{ group.subcategories|length }} subcategoría{{ 's' if group.subcategories|length != 1 }}
            {% endif %}
          </p>
        </div>
        {% if current_user and current_user.is_superuser %}
        <a class="button button--soft" href="/admin/upload">Administrar documentos</a>
        {% endif %}
      </header>

      {% if group.documents %}
      <section class="library-panel__section">
        <header class="library-panel__section-header">
          <span class="library-panel__eyebrow">Colección general</span>
          <h3>Material disponible para toda la congregación</h3>
        </header>
        <div class="library-document-list" data-doc-collection>
          {% for doc in group.documents %}
          {{ document_card(doc, current_user, "row") }}
          {% endfor %}
        </div>
      </section>
      {% endif %}

      {% if group.subcategories %}
      <section class="library-panel__section library-panel__section--accordion">
        <header class="library-panel__section-header">
          <span class="library-panel__eyebrow">Subcategorías</span>
          <h3>Recursos organizados por etapas de aprendizaje</h3>
        </header>
        <div class="library-accordion">
          {% for bundle in group.subcategories %}
          <details class="library-accordion__item" {% if loop.first %}open{% endif %}>
            <summary class="library-accordion__summary">
              <span class="library-accordion__name">{{ bundle.subcategory.name }}</span>
              <span class="library-accordion__count">
                {{ bundle.documents|length }} recurso{{ 's' if bundle.documents|length != 1 }}
              </span>
            </summary>
            {% if bundle.documents %}
            <div class="library-document-grid library-document-grid--compact" data-doc-collection>
              {% for doc in bundle.documents %}
              {{ document_card(doc, current_user, "compact") }}
              {% endfor %}
            </div>
            {% else %}
            <p class="library-panel__empty">
              Todavía no hay recursos en esta subcategoría.
            </p>
            {% endif %}
          </details>
          {% endfor %}
        </div>
      </section>
      {% endif %}

      {% if not group.documents and not group.subcategories %}
      <p class="library-panel__empty">
        Aún no se han incorporado recursos a esta categoría.
      </p>
      {% endif %}
    </article>
    {% endfor %}

    {% if uncategorized_documents %}
    <article
      class="library-panel"
      id="category-uncategorized"
      role="tabpanel"
      aria-labelledby="tab-category-uncategorized"
      data-library-panel
    >
      <header class="library-panel__header">
        <div>
          <span class="library-panel__eyebrow">Colección</span>
          <h2>Sin categoría</h2>
          <p>{{ uncategorized_documents|length }} recurso{{ 's' if uncategorized_documents|length != 1 }}</p>
        </div>
      </header>
  <div class="library-document-grid" data-doc-collection>
    {% for doc in uncategorized_documents %}
    {{ document_card(doc, current_user, "row") }}
    {% endfor %}
  </div>
</article>
{% endif %}
  </section>
</div>
{% else %}
<p class="empty empty--center">
  Todavía no hay documentos en la biblioteca. Comienza cargando materiales desde el
  panel administrativo.
</p>
{% endif %}
{% endblock %}
