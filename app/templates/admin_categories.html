{% extends "base.html" %}

{% block title %}Categorías | Biblioteca Apostólica{% endblock %}
{% block body_class %}page-admin-categories{% endblock %}

{% block masthead %}
<section class="page-hero">
  <div class="page-hero__content">
    <h1>Gestión de categorías</h1>
    <p>
      Crea y administra las categorías que organizan los recursos de la
      biblioteca. Un buen orden ayuda a toda la congregación.
    </p>
  </div>
</section>
{% endblock %}

{% block surface_class %}surface-admin{% endblock %}

{% block content %}
<div class="admin-categories">
  <section class="admin-card admin-card--form">
    <header class="admin-card__header">
      <h2>Nueva categoría</h2>
      <p>Agrega categorías para clasificar los documentos cargados.</p>
    </header>

    {% if message %}
    <p class="form-messages form-messages--success">{{ message }}</p>
    {% endif %}

    {% if errors %}
    <ul class="form-messages form-messages--error">
      {% for error in errors %}
      <li>{{ error }}</li>
      {% endfor %}
    </ul>
    {% endif %}

    <form class="form-grid" action="/admin/categories" method="post">
      <div class="form-field">
        <label class="form-label" for="name">Nombre de la categoría</label>
        <input
          class="form-input"
          type="text"
          id="name"
          name="name"
          placeholder="Ej. Informes, Manuales, Juventud..."
          required
        />
      </div>
      <button type="submit" class="button button--primary">Crear categoría</button>
    </form>
  </section>

  <section class="admin-card admin-card--list">
    <header class="admin-card__header admin-card__header--split">
      <div>
        <h2>Categorías existentes</h2>
        <p>Gestiona o elimina categorías y crea subcategorías específicas para cada ministerio.</p>
      </div>
      <div class="reorder-toolbar" data-reorder-toolbar>
        <button
          class="button button--ghost"
          type="button"
          data-reorder-toggle
          aria-expanded="false"
        >
          Organizar orden
        </button>
        <div class="reorder-toolbar__actions" data-reorder-actions hidden>
          <button class="button button--primary" type="button" data-reorder-save>
            Guardar orden
          </button>
          <button class="button button--ghost" type="button" data-reorder-cancel>
            Cancelar
          </button>
        </div>
        <p class="reorder-toolbar__status" data-reorder-status aria-live="polite"></p>
      </div>
    </header>

    {% if categories %}
    <div
      class="reorder-surface"
      data-reorder
      data-reorder-endpoint="/admin/categories/reorder"
      data-reorder-message="Orden de categorías actualizado."
    >
    <ul class="category-deck" data-reorder-list>
      {% for category in categories %}
      {% set subcategories = category.subcategories | sort(attribute='display_order') %}
      <li class="category-chip" data-reorder-item data-id="{{ category.id }}">
        <div class="category-chip__badge" aria-hidden="true">
          {{ category.name[0] }}
        </div>
        <span class="category-chip__handle" aria-hidden="true"></span>
        <span class="sr-only">Arrastra la categoría {{ category.name }} para reordenarla.</span>
        <div class="category-chip__body">
          <header class="category-chip__header">
            <div>
              <h3>{{ category.name }}</h3>
              <p>Creada el {{ category.created_at.strftime("%d/%m/%Y") }}</p>
              <p class="category-chip__meta">
                {{ category.documents|length }} documento{{ 's' if category.documents|length != 1 }}
              </p>
            </div>
            <div class="category-chip__controls">
              <form action="/admin/categories/{{ category.id }}/move" method="post">
                <input type="hidden" name="direction" value="up" />
                <button class="order-button" type="submit" title="Mover hacia arriba" aria-label="Mover categoría {{ category.name }} hacia arriba">▲</button>
              </form>
              <form action="/admin/categories/{{ category.id }}/move" method="post">
                <input type="hidden" name="direction" value="down" />
                <button class="order-button" type="submit" title="Mover hacia abajo" aria-label="Mover categoría {{ category.name }} hacia abajo">▼</button>
              </form>
              <form
                class="action-inline-form"
                action="/admin/categories/{{ category.id }}/delete"
                method="post"
                data-action="delete-category"
                data-name="{{ category.name }}"
              >
                <button class="link-danger" type="submit">Eliminar</button>
              </form>
            </div>
          </header>
          <div class="subcategory-board">
            <h4>Subcategorías</h4>
            {% if subcategories %}
            <ul class="subcategory-list">
              {% for subcategory in subcategories %}
              <li class="subcategory-item">
                <span class="badge badge--soft">{{ subcategory.name }}</span>
                <span class="subcategory-count">
                  {{ subcategory.documents|length }} doc{{ 's' if subcategory.documents|length != 1 }}
                </span>
                <div class="subcategory-item__controls">
                  <form action="/admin/subcategories/{{ subcategory.id }}/move" method="post">
                    <input type="hidden" name="direction" value="up" />
                    <button class="order-button" type="submit" title="Mover subcategoría hacia arriba" aria-label="Mover subcategoría {{ subcategory.name }} hacia arriba">▲</button>
                  </form>
                  <form action="/admin/subcategories/{{ subcategory.id }}/move" method="post">
                    <input type="hidden" name="direction" value="down" />
                    <button class="order-button" type="submit" title="Mover subcategoría hacia abajo" aria-label="Mover subcategoría {{ subcategory.name }} hacia abajo">▼</button>
                  </form>
                  <form
                    class="action-inline-form"
                    action="/admin/subcategories/{{ subcategory.id }}/delete"
                    method="post"
                    data-action="delete-subcategory"
                    data-name="{{ subcategory.name }}"
                  >
                    <button class="link-danger" type="submit" title="Eliminar subcategoría">
                      Eliminar
                    </button>
                  </form>
                </div>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <p class="subcategory-empty">Esta categoría aún no tiene subcategorías.</p>
            {% endif %}
            <form
              class="subcategory-form"
              action="/admin/categories/{{ category.id }}/subcategories"
              method="post"
            >
              <label class="sr-only" for="subcategory-name-{{ category.id }}">Nueva subcategoría</label>
              <input
                class="form-input"
                type="text"
                id="subcategory-name-{{ category.id }}"
                name="name"
                placeholder="Ej. Nacer, Crecer, Jóvenes..."
                required
              />
              <button class="button button--ghost" type="submit">Agregar</button>
            </form>
          </div>
        </div>
      </li>
      {% endfor %}
    </ul>
    <p class="reorder-hint" data-reorder-hint hidden>
      Arrastra y suelta las tarjetas para definir el orden. Luego guarda los cambios.
    </p>
    </div>
    {% else %}
    <p class="empty empty--center">
      Todavía no se han creado categorías.
    </p>
    {% endif %}
  </section>
</div>
{% endblock %}
