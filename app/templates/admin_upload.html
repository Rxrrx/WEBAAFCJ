{% extends "base.html" %}

{% block title %}Panel de superusuario | Biblioteca Apostólica{% endblock %}
{% block body_class %}page-admin-upload{% endblock %}

{% block masthead %}
<section class="hero hero--admin">
  <div class="hero__inner">
    <div class="hero__content">
      <h1>Panel de administración</h1>
      <p>
        Sube y organiza los recursos oficiales de la Asamblea. Mantén las
        categorías actualizadas para que la congregación encuentre rápidamente
        el material que necesita.
      </p>
      <div class="hero__actions">
        <a class="button button--outline" href="/admin/categories">
          Gestionar categorías
        </a>
        <a class="button button--ghost" href="/library">Ver biblioteca</a>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block surface_class %}surface-admin{% endblock %}

{% block content %}
<div class="admin-grid">
  <section class="admin-card admin-card--upload">
    <header class="admin-card__header">
      <h2>Nueva subida</h2>
      <p>Formatos permitidos: PDF, DOC, DOCX, PPT, PPTX y TXT ({{ max_file_size }} MB máximo).</p>
    </header>

    {% if categories %}
    <form
      class="form-grid"
      action="/upload"
      method="post"
      enctype="multipart/form-data"
      data-direct-upload='{{ direct_upload_config|tojson }}'
    >
      <div class="form-field">
        <label class="form-label" for="category_id">Categoría</label>
        <select
          class="form-input"
          id="category_id"
          name="category_id"
          required
          data-category-select
          data-category-map='{{ category_options|tojson }}'
        >
          <option value="" disabled selected>Selecciona una categoría</option>
          {% for category in categories %}
          <option value="{{ category.id }}">{{ category.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-field">
        <label class="form-label" for="subcategory_id">Subcategoría (opcional)</label>
        <select
          class="form-input"
          id="subcategory_id"
          name="subcategory_id"
          data-subcategory-select
          disabled
        >
          <option value="">Selecciona una subcategoría</option>
        </select>
        <p class="form-hint">Si la categoría tiene subcategorías, elige la que corresponda.</p>
      </div>

      <div class="form-field">
        <label class="form-label" for="file">Documento</label>
        <input
          class="form-input"
          type="file"
          id="file"
          name="file"
          required
          accept=".pdf,.doc,.docx,.ppt,.pptx,.txt"
        />
        <p class="form-hint">El archivo se almacenará de forma segura en el sistema.</p>
      </div>

      <button type="submit" class="button button--primary">Subir documento</button>
      {% if direct_upload_config.enabled %}
      <p class="form-hint form-hint--status" data-upload-status hidden></p>
      {% endif %}
    </form>
    {% else %}
    <div class="empty-card">
      <h3>No hay categorías disponibles</h3>
      <p>Crea una categoría antes de subir nuevos documentos.</p>
      <a class="button button--outline" href="/admin/categories">Gestionar categorías</a>
    </div>
    {% endif %}
  </section>

  <section class="admin-card admin-card--recent">
    <header class="admin-card__header">
      <h2>Subidas recientes</h2>
      <a class="link-arrow" href="/library">Ir a la biblioteca</a>
    </header>
    {% if documents %}
    <ul class="document-feed document-feed--admin">
      {% for doc in documents %}
      <li class="document-card">
        <div class="document-card__type" aria-hidden="true">
          {{ "PDF" if doc.content_type == "application/pdf" else "DOC" }}
        </div>
        <div class="document-card__body">
          <h3 class="document-card__title">{{ doc.filename }}</h3>
          <p class="document-card__meta">
            {{ doc.content_type }} &middot; {{ doc.uploaded_at.strftime("%d/%m/%Y %H:%M") }}
          </p>
          {% if doc.category %}
          <span class="badge">{{ doc.category.name }}</span>
          {% endif %}
          {% if doc.subcategory %}
          <span class="badge badge--soft">{{ doc.subcategory.name }}</span>
          {% endif %}
        </div>
        <div class="document-card__actions">
          <a
            class="button button--ghost"
            href="/documents/{{ doc.id }}/download"
            data-download-url="/documents/{{ doc.id }}/download"
            data-filename="{{ doc.filename }}"
          >
            Descargar
          </a>
          {% if doc.content_type == "application/pdf" %}
          <a
            class="button button--outline"
            href="/documents/{{ doc.id }}/view"
            data-view-url="/documents/{{ doc.id }}/view"
            data-filename="{{ doc.filename }}"
          >
            Abrir
          </a>
          {% endif %}
          <form
            class="action-inline-form"
            action="/documents/{{ doc.id }}/delete"
            method="post"
            data-action="delete-doc"
            data-filename="{{ doc.filename }}"
          >
            <button class="link-danger" type="submit">Eliminar</button>
          </form>
        </div>
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <p class="empty empty--center">
      Todavía no hay documentos almacenados.
    </p>
    {% endif %}
  </section>

  <section
    class="admin-card admin-card--organizer"
    data-document-organizer
    data-organizer-config='{{ document_organizer_config|tojson }}'
    data-organizer-categories='{{ category_options|tojson }}'
  >
    <header class="admin-card__header">
      <h2>Organiza el orden de los documentos</h2>
      <p>Selecciona una categoría o subcategoría y arrastra los archivos para definir qué se muestra primero.</p>
    </header>
    <div class="organizer-grid">
      <div class="organizer-grid__controls">
        <div class="form-field">
          <label class="form-label" for="organizer-category">Categoría</label>
          <select class="form-input" id="organizer-category" data-organizer-category>
            <option value="">Documentos sin categoría</option>
            {% for category in categories %}
            <option value="{{ category.id }}">{{ category.name }}</option>
            {% endfor %}
          </select>
          <p class="form-hint">Si no eliges ninguna categoría podrás ordenar los archivos sin clasificar.</p>
        </div>
        <div class="form-field">
          <label class="form-label" for="organizer-subcategory">Subcategoría (opcional)</label>
          <select
            class="form-input"
            id="organizer-subcategory"
            data-organizer-subcategory
            disabled
          >
            <option value="">Selecciona una subcategoría</option>
          </select>
          <p class="form-hint">Cuando seleccionas una subcategoría, solo se mostrarán los archivos asociados a ella.</p>
        </div>
      </div>
      <div
        class="organizer-list"
        data-reorder
        data-reorder-endpoint="/admin/documents/reorder"
        data-reorder-message="Orden de documentos actualizado."
        data-reorder-field="documents"
      >
        <div class="organizer-list__loader" data-organizer-loader hidden>
          <div class="spinner" aria-hidden="true"></div>
          <p>Cargando documentos...</p>
        </div>
        <div class="organizer-list__meta" data-organizer-meta></div>
        <div class="organizer-list__empty" data-organizer-empty>
          Selecciona una categoría o subcategoría para ver sus documentos.
        </div>
        <ul class="organizer-items" data-reorder-list></ul>
        <p class="reorder-hint" data-reorder-hint hidden>
          Arrastra los elementos usando el control lateral y luego guarda los cambios.
        </p>
        <div class="reorder-toolbar" data-reorder-toolbar>
          <button class="button button--ghost" type="button" data-reorder-toggle disabled aria-expanded="false">
            Editar orden
          </button>
          <div class="reorder-toolbar__actions" data-reorder-actions hidden>
            <button class="button button--primary" type="button" data-reorder-save>Guardar</button>
            <button class="button button--ghost" type="button" data-reorder-cancel>Cancelar</button>
          </div>
          <p class="reorder-toolbar__status" data-reorder-status aria-live="polite"></p>
        </div>
      </div>
    </div>
  </section>
</div>
{% endblock %}
