{% extends "base.html" %}

{% block title %}Inicio | Biblioteca Apostólica{% endblock %}
{% block body_class %}page-home{% endblock %}

{% block masthead %}
<section class="hero hero--home">
  <div class="hero__legend">
    <span class="hero__badge">
      <span>Asamblea Apostólica de la Fe en Cristo Jesús</span>
      <span class="hero__badge-divider" aria-hidden="true">·</span>
      <span>Pedro Aguirre Cerda</span>
    </span>
    <span class="hero__badge hero__badge--motto">
      Sacrificio - Identidad - Compromiso
    </span>
  </div>
  <div class="hero__inner">
    <div class="hero__content">
      <h1>Biblioteca Apostólica</h1>
      <p>
        Fortalece el aprendizaje bíblico de cada ministerio con una biblioteca ordenada, segura
        y disponible para guías, maestros y equipos de servicio.
      </p>
      <div class="hero__actions">
        <a class="button button--primary" href="/library">Explorar biblioteca</a>
        {% if current_user %}
        {% if current_user.is_superuser %}
        <a class="button button--outline" href="/admin/upload">Panel de administración</a>
        {% else %}
        <a class="button button--ghost" href="/profile">Ver mi historial</a>
        {% endif %}
        {% else %}
        <a class="button button--ghost" href="/register">Solicitar acceso</a>
        {% endif %}
      </div>
    </div>
    <div class="hero__media">
      {% if sermon_document %}
      <article class="sermon-card sermon-card--hero">
        <div class="sermon-card__head">
          <div class="sermon-card__tags">
            <span class="badge">{{ sermon_document.category.name if sermon_document.category else sermon_category_name }}</span>
            {% if sermon_document.subcategory %}
            <span class="badge badge--soft">{{ sermon_document.subcategory.name }}</span>
            {% endif %}
          </div>
          <time class="sermon-card__date" datetime="{{ sermon_document.uploaded_at.isoformat() }}">
            Publicado el {{ sermon_document.uploaded_at.strftime("%d/%m/%Y %H:%M") }}
          </time>
        </div>
        <h3 class="sermon-card__title">Sermón de la semana</h3>
        <p class="sermon-card__lead">
          {{ sermon_document.filename }}
        </p>
        <div class="sermon-card__actions">
          <a
            class="button button--primary"
            href="/documents/{{ sermon_document.id }}/download"
            data-download-url="/documents/{{ sermon_document.id }}/download"
            data-filename="{{ sermon_document.filename }}"
          >
            Descargar
          </a>
          {% if sermon_document.content_type == "application/pdf" %}
          <a
            class="button button--outline"
            href="/documents/{{ sermon_document.id }}/view"
            data-view-url="/documents/{{ sermon_document.id }}/view"
            data-filename="{{ sermon_document.filename }}"
          >
            Ver en línea
          </a>
          {% endif %}
        </div>
      </article>
      {% else %}
      <div class="hero-card hero-card--placeholder">
        <h3 class="hero-card__title">Organiza tus estudios semanales</h3>
        <p class="hero-card__caption">
          Destaca aquí el último mensaje cargado en la categoría {{ sermon_category_name }}.
        </p>
        <ul class="hero-card__list">
          <li>Guarda bosquejos, hojas de trabajo y devocionales.</li>
          <li>Actualiza el recurso semanal desde el panel administrativo.</li>
          <li>Facilita el repaso para grupos familiares y liderazgo juvenil.</li>
        </ul>
      </div>
      {% endif %}
    </div>
  </div>
</section>
{% endblock %}

{% block surface_class %}surface-home{% endblock %}

{% block content %}
<section class="module module--intro">
  <div class="module__headline">
    <h2>Material de formación al alcance de la iglesia</h2>
    <p>
      Conecta a maestros, líderes y estudiantes con recursos actualizados, ordenados por rutas de
      aprendizaje y listos para descargar en cualquier momento.
    </p>
  </div>
  <div class="pillars">
    <article class="pillar">
      <h3>Biblioteca Organizada</h3>
      <p>
        Encuentra todo el material de manera estructurada y ordenada en nuestra sección de biblioteca.
      </p>
    </article>
    <article class="pillar">
      <h3>Material listo para enseñar</h3>
      <p>
        Descarga PDF, presentaciones y documentos de apoyo antes de cada reunión o clase bíblica.
      </p>
    </article>
    <article class="pillar">
      <h3>Seguimiento pastoral</h3>
      <p>
        Los responsables revisan qué materiales se consultan y mantienen la biblioteca al día.
      </p>
    </article>
  </div>
</section>

<section class="module module--latest">
  <header class="module__header">
    <div>
      <h2>Últimos recursos añadidos</h2>
      <p>Consulta los documentos que se han incorporado recientemente.</p>
    </div>
    <a class="link-arrow" href="/library">Ir a la biblioteca</a>
  </header>
  {% if documents %}
  <ul class="document-feed">
    {% for doc in documents %}
    <li class="document-card document-card--compact">
      {%- set _ext = (doc.filename.split('.')[-1].upper() if '.' in doc.filename else (doc.content_type.split('/')[-1].upper() if '/' in doc.content_type else doc.content_type)) -%}
      <div class="document-card__type" aria-hidden="true">
        {{ _ext if _ext in ['PDF','PPT','PPTX','DOC','DOCX','TXT'] else _ext[:6] }}
      </div>
      <div class="document-card__body">
        <h3 class="document-card__title">{{ doc.filename }}</h3>
        <p class="document-card__meta">
          {{ doc.content_type.split('/')[-1].upper() if '/' in doc.content_type else doc.content_type }}
          · {{ doc.uploaded_at.strftime("%d/%m/%Y %H:%M") }}
        </p>
        {% if doc.category %}
        <span class="badge">{{ doc.category.name }}</span>
        {% endif %}
        {% if doc.subcategory %}
        <span class="badge badge--soft">{{ doc.subcategory.name }}</span>
        {% endif %}
      </div>
      <div class="document-card__actions">
        <a
          class="button button--ghost"
          href="/documents/{{ doc.id }}/download"
          data-download-url="/documents/{{ doc.id }}/download"
          data-filename="{{ doc.filename }}"
        >
          Descargar
        </a>
        {# keep layout consistent: show 'Abrir' for all types (PDF -> viewer, others -> download) #}
        <a
          class="button button--outline"
          href="{% if doc.content_type == 'application/pdf' %}/documents/{{ doc.id }}/view{% else %}/documents/{{ doc.id }}/download{% endif %}"
          {% if doc.content_type == 'application/pdf' %}data-view-url="/documents/{{ doc.id }}/view"{% endif %}
          data-filename="{{ doc.filename }}"
        >
          Abrir
        </a>
        {% if current_user and current_user.is_superuser %}
        <form
          class="action-inline-form"
          action="/documents/{{ doc.id }}/delete"
          method="post"
          data-action="delete-doc"
          data-filename="{{ doc.filename }}"
        >
          <button class="link-danger" type="submit">Eliminar</button>
        </form>
        {% endif %}
      </div>
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <p class="empty empty--center">
    Aún no hay documentos cargados. Los recursos aparecerán aquí cuando se incorporen a la biblioteca.
  </p>
  {% endif %}
</section>

{% if featured_categories %}
<section class="module module--learning">
  <header class="module__header">
    <div>
      <h2>Material de aprendizaje disponible</h2>
      <p>Comienza tu búsqueda de recursos eligiendo la categoría que mejor apoye tus estudios.</p>
    </div>
  </header>
  <div class="pathway-grid">
    {% for item in featured_categories %}
    <article class="pathway-card">
      <h3>{{ item.name }}</h3>
      <p>
        {{ item.documents }} recurso{{ 's' if item.documents != 1 }}
        {% if item.subcategories %}
        · {{ item.subcategories|length }} subcategoría{{ 's' if item.subcategories|length != 1 }}
        {% endif %}
      </p>
      {% if item.subcategories %}
      <ul class="pathway-card__list">
        {% for name in item.subcategories[:3] %}
        <li>{{ name }}</li>
        {% endfor %}
        {% if item.subcategories|length > 3 %}
        <li>y más…</li>
        {% endif %}
      </ul>
      {% else %}
      {% endif %}
      <a class="button button--soft" href="/library#category-{{ item.id }}">Ver categoría</a>
    </article>
    {% endfor %}
  </div>
</section>
{% endif %}

<section class="module module--map">
  <header class="module__header">
    <div>
      <h2>Encuéntranos</h2>
      <p>Visita nuestra congregación y disfruta de la comunión en {{ church_address }}.</p>
    </div>
  </header>
  <div class="map-board" data-map-root>
    <div
      class="map-board__canvas"
      data-map-placeholder
      data-address="{{ church_address }}"
      data-map-token="{{ mapbox_token }}"
    >
      <p>
        Integra aquí tu mapa preferido (Mapbox, Google Maps, OpenStreetMap) utilizando el atributo
        <code>data-address</code> para centrar la ubicación.
      </p>
      <p class="map-board__address">
        Dirección: <strong>{{ church_address }}</strong>
      </p>
    </div>
    <aside class="map-board__details">
      <h3>Planifica tu visita</h3>
      <ul>
        <li>Coordina con anticipación horarios de discipulado y ensayos.</li>
        <li>Comparte la ubicación con nuevos asistentes y familias.</li>
        <li>Promueve encuentros en grupos de amistad durante la semana.</li>
      </ul>
      <a
        class="button button--ghost"
        href="https://www.google.com/maps/search/?api=1&query={{ church_address | urlencode }}"
        target="_blank"
        rel="noopener"
      >
        Abrir en Google Maps
      </a>
    </aside>
  </div>
</section>
{% endblock %}
